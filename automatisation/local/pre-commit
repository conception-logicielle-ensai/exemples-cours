#!/bin/bash
set -e

echo "=== Hook pre-commit ==="

# Tous les fichiers du staging (sauf suppressions)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=d || true)

if [ -z "$STAGED_FILES" ]; then
    echo "Aucun fichier à analyser."
    exit 0
fi

echo "Fichiers analysés :"
echo "$STAGED_FILES"
echo

# ---------------------------------------------------
# Étape 1 — Formatage automatique
# ---------------------------------------------------
echo "[1/2] Formatage automatique (ruff format)"
if uv run ruff format $STAGED_FILES; then
    echo "Formatage terminé avec succès."
else
    echo "Erreur lors du formatage."
    echo "Le commit est bloqué."
    exit 1
fi
echo

# ---------------------------------------------------
# Étape 2 — Corrections automatiques
# ---------------------------------------------------
echo "[2/2] Corrections automatiques (ruff check --fix)"
if uv run ruff check --fix $STAGED_FILES; then
    echo "Corrections automatiques appliquées."
else
    echo "Certaines règles Ruff ne peuvent pas être corrigées automatiquement."
    echo "Des erreurs Ruff nécessitent une correction manuelle."
    echo "Le commit est bloqué."
    exit 1
fi
echo


# ---------------------------------------------------
# Mise à jour du staging
# ---------------------------------------------------
echo "Mise à jour du staging..."
git add $STAGED_FILES

echo "Toutes les vérifications Ruff sont passées."
echo "Commit autorisé."
exit 0