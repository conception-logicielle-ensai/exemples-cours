[tox]
envlist = api,showcase
skipsdist = True

[testenv:api]
description = ðŸš€ Lance le serveur FastAPI
allowlist_externals = 
    uv
    bash
commands = bash -c 'uv sync --dev; \
                    uv run uvicorn main:app --host 0.0.0.0 --port 8000'

[testenv:load-test]
description = ðŸŽ¯ DEMO - Lance l'API + Locust UI automatiquement
allowlist_externals = 
    bash
    sleep
    pkill
    echo
    uv
commands =
    bash -c 'echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"; \
             echo "ðŸš€ DÃ‰MARRAGE DE LA DÃ‰MO VITRINE"; \
             echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"; \
             echo ""; \
             echo "ðŸ“ Ã‰tape 1/3: Lancement du serveur FastAPI..."; \
             uv sync --dev; \
             uv run uvicorn main:app --host 0.0.0.0 --port 8000 > /dev/null 2>&1 & \
             API_PID=$!; \
             echo "   âœ… API dÃ©marrÃ©e (PID: $API_PID)"; \
             echo "   ðŸ“¡ API disponible sur: http://localhost:8000"; \
             echo "   ðŸ“š Documentation Swagger: http://localhost:8000/docs"; \
             echo ""; \
             echo "â³ Attente de 5 secondes pour initialisation..."; \
             sleep 5; \
             echo ""; \
             echo "ðŸ“ Ã‰tape 2/3: Lancement de Locust UI..."; \
             echo "   ðŸŒ Interface Locust: http://localhost:8089"; \
             echo ""; \
             echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"; \
             echo "âœ¨ TOUT EST PRÃŠT! Ouvrez http://localhost:8089"; \
             echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"; \
             echo ""; \
             echo "ðŸ“‹ Configuration recommandÃ©e:"; \
             echo "   â€¢ Nombre d'\''utilisateurs: 50"; \
             echo "   â€¢ Spawn rate: 10 users/sec"; \
             echo "   â€¢ Host: http://localhost:8000 (prÃ©-configurÃ©)"; \
             echo ""; \
             echo "âš¡ Les tests dÃ©marrent automatiquement dans 3s..."; \
             sleep 3; \
             uv run locust -f locustfile.py --host=http://localhost:8000 --autostart --users 50 --spawn-rate 10; \
             echo ""; \
             echo "ðŸ›‘ ArrÃªt de l'\''API..."; \
             kill $API_PID 2>/dev/null || true'